import hashlib, glob, os
import sys
import shutil
import time
from datetime import datetime

def log(str):
	print "[" + datetime.today().strftime("%Y%m%d %H%M%S") + "] " + str
	
def file2md5(filename):
    md5 = hashlib.md5()
    with open(filename, 'rb') as f:
        for chunk in iter(lambda: f.read(8192), ''):
            md5.update(chunk)
    return md5.hexdigest()
	
def extractApiLog(filename):
	log("Extract Api Log : " + filename)
	#\bsa\bsa.exe -s 30 -i "c:\WINDOWS\explorer.exe "
	path = "c:\\bsa\\bsa.exe"
	options = " -s 30 -i"
	cmd = path + options + " \"" + filename + "\""
	log("cmd : " + cmd)
	os.system(cmd)
	time.sleep(40)

	
def moveResult(md5):	
	log("Move Result : " + md5)
	flist = glob.glob('c:\\bsa\\Reports\\*')
	count = 1
	filename = "LOG_API.TXT"
	resultFolder = ".\\result\\"
	for i in flist:
		targetPath = i
		print "Check File : " + targetPath + "\\" + filename
		srcFile = targetPath + "\\" + filename
		dstFile = resultFolder + "\\" + md5 + ".txt"
		shutil.move(srcFile, dstFile)
		shutil.rmtree(i)

if __name__ == "__main__":
	print "##############################################"
	print "# Preprocess for analyse binary              #"
	print "# * Sequence                                 #"
	print "# 1) list files at Argument#1                #"
	print "# 2) md5 file                                #"
	print "# 3) extract api log                         #"
	print "# 4) move result to ResultDir                #"
	print "##############################################"
	
	flist = glob.glob('c:\\temp\\mal_1000\\*')
	count = 1
	for i in flist:
		log("File Count : " + str(count))
		count += 1
		targetFile = i
		log("Target File : " + targetFile)
		md5 = file2md5(i)
		log("File size : %d" % os.path.getsize(i))
		log("File MD5 : %s" % md5)
		extractApiLog(targetFile)
		moveResult(md5)